        // é¡µé¢åŠ è½½æ—¶æ£€æŸ¥ç™»å½•çŠ¶æ€
        document.addEventListener('DOMContentLoaded', async function() {
            await checkAuth();
            updateTime();
            setInterval(updateTime, 1000);
            
            // æ¨¡æ‹Ÿå®æ—¶æ•°æ®æ›´æ–°
            updateStockData();
            setInterval(updateStockData, 5000);
            
            // åˆå§‹åŒ–Excelä¸Šä¼ åŠŸèƒ½
            initExcelUpload();
            
            // åˆå§‹åŒ–é¡µç­¾åŠŸèƒ½
            initTabs();
            
            // é¡µé¢åŠ è½½å®Œæˆåï¼Œå»¶è¿ŸåŠ è½½ç”¨æˆ·æŒä»“æ•°æ®
            setTimeout(() => {
                loadUserPositions();
            }, 500);
        });
        
        // æ‰“å¼€Excelä¸Šä¼ æ¨¡æ€æ¡†
        function openExcelUploadModal() {
            const modal = document.getElementById('excelUploadModal');
            modal.style.display = 'block';
            
            // æ¸…ç©ºä¸Šä¼ çŠ¶æ€
            clearUploadStatus();
            
            // é‡æ–°ç»‘å®šæ‹–æ‹½äº‹ä»¶ï¼ˆç¡®ä¿æ¨¡æ€æ¡†æ˜¾ç¤ºåäº‹ä»¶ç»‘å®šæ­£ç¡®ï¼‰
            initExcelUpload();
        }
        
        // å…³é—­Excelä¸Šä¼ æ¨¡æ€æ¡†
        function closeExcelUploadModal() {
            const modal = document.getElementById('excelUploadModal');
            modal.style.display = 'none';
            
            // æ¸…ç©ºä¸Šä¼ çŠ¶æ€
            clearUploadStatus();
        }
        
        // æ¸…ç©ºä¸Šä¼ çŠ¶æ€
        function clearUploadStatus() {
            const uploadStatus = document.getElementById('uploadStatus');
            uploadStatus.textContent = '';
            uploadStatus.className = 'upload-status';
            
            // æ¸…ç©ºæ–‡ä»¶è¾“å…¥
            const fileInput = document.getElementById('excelFileInput');
            fileInput.value = '';
        }

        // åˆå§‹åŒ–Excelä¸Šä¼ åŠŸèƒ½
        function initExcelUpload() {
            const uploadArea = document.getElementById('excelUploadArea');
            const fileInput = document.getElementById('excelFileInput');
            
            if (!uploadArea || !fileInput) return;
            
            // æ‹–æ‹½äº‹ä»¶å¤„ç†
            uploadArea.addEventListener('dragover', function(e) {
                e.preventDefault();
                uploadArea.classList.add('dragover');
            });
            
            uploadArea.addEventListener('dragleave', function(e) {
                e.preventDefault();
                uploadArea.classList.remove('dragover');
            });
            
            uploadArea.addEventListener('drop', function(e) {
                e.preventDefault();
                uploadArea.classList.remove('dragover');
                
                const files = e.dataTransfer.files;
                if (files.length > 0) {
                    handleExcelFile(files[0]);
                }
            });
            
            // æ–‡ä»¶é€‰æ‹©äº‹ä»¶
            fileInput.addEventListener('change', function(e) {
                if (e.target.files.length > 0) {
                    handleExcelFile(e.target.files[0]);
                }
            });
        }

        // å¤„ç†Excelæ–‡ä»¶ä¸Šä¼ 
        async function handleExcelFile(file) {
            if (!file) return;
            
            // æ£€æŸ¥æ–‡ä»¶ç±»å‹
            const validTypes = ['.xls', '.xlsx'];
            const fileExtension = file.name.toLowerCase().slice(file.name.lastIndexOf('.'));
            
            if (!validTypes.includes(fileExtension)) {
                showUploadStatus('è¯·ä¸Šä¼ .xlsæˆ–.xlsxæ ¼å¼çš„Excelæ–‡ä»¶', 'error');
                return;
            }
            
            const token = localStorage.getItem('token');
            if (!token) {
                showUploadStatus('è¯·å…ˆç™»å½•ç³»ç»Ÿ', 'error');
                return;
            }
            
            try {
                showUploadStatus('æ­£åœ¨ä¸Šä¼ æ–‡ä»¶...', 'info');
                
                const formData = new FormData();
                formData.append('file', file);
                
                const response = await fetch('/api/upload/positions', {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`
                    },
                    body: formData
                });
                
                const data = await response.json();
                
                if (data.success) {
                    showUploadStatus('æ–‡ä»¶ä¸Šä¼ æˆåŠŸï¼æ­£åœ¨è§£ææŒä»“æ•°æ®...', 'success');
                    
                    // å»¶è¿Ÿåæ˜¾ç¤ºæŒä»“æ•°æ®
                    setTimeout(() => {
                        displayUploadedPositions(data.data.positions, data.data.summary);
                        showUploadStatus('æ•°æ®è§£æå®Œæˆï¼', 'success');
                        
                        // ä¸Šä¼ æˆåŠŸåå…³é—­æ¨¡æ€æ¡†
                        setTimeout(() => {
                            closeExcelUploadModal();
                        }, 500);
                    }, 1000);
                    
                } else {
                    showUploadStatus(data.error || 'æ–‡ä»¶ä¸Šä¼ å¤±è´¥', 'error');
                }
                
            } catch (error) {
                console.error('Excelæ–‡ä»¶ä¸Šä¼ é”™è¯¯:', error);
                showUploadStatus('ç½‘ç»œè¿æ¥å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œåé‡è¯•', 'error');
            }
        }

        // æ˜¾ç¤ºä¸Šä¼ çŠ¶æ€
        function showUploadStatus(message, type) {
            const statusDiv = document.getElementById('uploadStatus');
            if (!statusDiv) return;
            
            statusDiv.textContent = message;
            statusDiv.className = `upload-status ${type}`;
            statusDiv.style.display = 'block';
        }

        // æ¸…ç©ºä¸Šä¼ çš„æ•°æ®
        async function clearUploadedData() {
            const token = localStorage.getItem('token');
            
            if (!token) {
                // æœªç™»å½•çŠ¶æ€ï¼Œåªæ¸…ç©ºæœ¬åœ°æ˜¾ç¤º
                document.getElementById('uploadedTotalValue').textContent = 'Â¥0.00';
                document.getElementById('uploadedProfitLoss').textContent = 'æ€»ç›ˆäº: Â¥0.00 (0.00%)';
                document.getElementById('uploadedPositions').innerHTML = 
                    '<div class="loading-text">è¯·ä¸Šä¼ Excelæ–‡ä»¶æŸ¥çœ‹æŒä»“æ•°æ®</div>';
                
                const statusDiv = document.getElementById('uploadStatus');
                if (statusDiv) {
                    statusDiv.style.display = 'none';
                    statusDiv.textContent = '';
                }
                
                const fileInput = document.getElementById('excelFileInput');
                if (fileInput) fileInput.value = '';
                
                // ç§»é™¤æ›´æ–°æ—¶é—´ä¿¡æ¯
                const updateInfo = document.getElementById('positionUpdateInfo');
                if (updateInfo) {
                    updateInfo.remove();
                }
                
                return;
            }
            
            // ç¡®è®¤æ¸…ç©ºæ“ä½œ
            if (!confirm('ç¡®å®šè¦æ¸…ç©ºæ‰€æœ‰æŒä»“æ•°æ®å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¤ã€‚')) {
                return;
            }
            
            try {
                const response = await fetch('/api/positions', {
                    method: 'DELETE',
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });
                
                if (response.ok) {
                    const result = await response.json();
                    if (result.success) {
                        // æ¸…ç©ºæœ¬åœ°æ˜¾ç¤º
                        document.getElementById('uploadedTotalValue').textContent = 'Â¥0.00';
                        document.getElementById('uploadedProfitLoss').textContent = 'æ€»ç›ˆäº: Â¥0.00 (0.00%)';
                        document.getElementById('uploadedPositions').innerHTML = 
                            '<div class="loading-text">è¯·ä¸Šä¼ Excelæ–‡ä»¶æŸ¥çœ‹æŒä»“æ•°æ®</div>';
                        
                        const statusDiv = document.getElementById('uploadStatus');
                        if (statusDiv) {
                            statusDiv.style.display = 'none';
                            statusDiv.textContent = '';
                        }
                        
                        const fileInput = document.getElementById('excelFileInput');
                        if (fileInput) fileInput.value = '';
                        
                        // ç§»é™¤æ›´æ–°æ—¶é—´ä¿¡æ¯
                        const updateInfo = document.getElementById('positionUpdateInfo');
                        if (updateInfo) {
                            updateInfo.remove();
                        }
                        
                        showNotification('æŒä»“æ•°æ®å·²æ¸…ç©º', 'success');
                        console.log(`âœ… æŒä»“æ•°æ®å·²æ¸…ç©ºï¼Œåˆ é™¤äº† ${result.deletedCount} æ¡è®°å½•`);
                    } else {
                        showNotification('æ¸…ç©ºæ•°æ®å¤±è´¥ï¼š' + (result.error || 'æœªçŸ¥é”™è¯¯'), 'error');
                    }
                } else {
                    showNotification('æ¸…ç©ºæ•°æ®å¤±è´¥ï¼Œè¯·é‡è¯•', 'error');
                }
            } catch (error) {
                console.error('æ¸…ç©ºæŒä»“æ•°æ®é”™è¯¯:', error);
                showNotification('æ¸…ç©ºæ•°æ®å¤±è´¥ï¼Œç½‘ç»œè¿æ¥é”™è¯¯', 'error');
            }
        }

        // æ£€æŸ¥è®¤è¯çŠ¶æ€
        async function checkAuth() {
            const token = localStorage.getItem('token');
            const user = localStorage.getItem('user');
            
            if (token && user) {
                try {
                    const response = await fetch('/api/auth/me', {
                        headers: {
                            'Authorization': `Bearer ${token}`
                        }
                    });

                    if (response.ok) {
                        const userData = await response.json();
                        updateNavbar(userData);
                        return;
                    }
                } catch (error) {
                    console.error('è®¤è¯æ£€æŸ¥å¤±è´¥:', error);
                }
            }
            
            // æœªç™»å½•çŠ¶æ€
            updateNavbar(null);
        }

        // æ˜¾ç¤ºä¸Šä¼ çš„æŒä»“æ•°æ®
        function displayUploadedPositions(positions, summary = null) {
            const container = document.getElementById('uploadedPositions');
            const totalValueEl = document.getElementById('uploadedTotalValue');
            const profitLossEl = document.getElementById('uploadedProfitLoss');
            
            if (!container || !totalValueEl || !profitLossEl) return;
            
            if (!positions || positions.length === 0) {
                container.innerHTML = '<div class="loading-text">æœªæ‰¾åˆ°æŒä»“æ•°æ®</div>';
                totalValueEl.textContent = 'Â¥0.00';
                profitLossEl.textContent = 'æ€»ç›ˆäº: Â¥0.00 (0.00%)';
                
                // ç§»é™¤æ›´æ–°æ—¶é—´ä¿¡æ¯
                const updateInfo = document.getElementById('positionUpdateInfo');
                if (updateInfo) {
                    updateInfo.remove();
                }
                
                return;
            }
            
            // å¦‚æœæä¾›äº†æ±‡æ€»ä¿¡æ¯ï¼Œç›´æ¥ä½¿ç”¨ï¼Œå¦åˆ™é‡æ–°è®¡ç®—
            let totalMarketValue, totalProfitLoss, totalCost, profitLossRate;
            if (summary) {
                totalMarketValue = summary.totalMarketValue;
                totalProfitLoss = summary.totalProfitLoss;
                totalCost = summary.totalCost || 0;
                profitLossRate = summary.totalProfitLossRate;
                
                // æ˜¾ç¤ºæ›´æ–°æ—¶é—´ä¿¡æ¯
                if (summary.lastUpdate) {
                    const updateTime = new Date(summary.lastUpdate).toLocaleString('zh-CN');
                    
                    // åˆ›å»ºæˆ–æ›´æ–°çŠ¶æ€æ˜¾ç¤ºå…ƒç´ 
                    let statusDiv = document.getElementById('positionUpdateInfo');
                    if (!statusDiv) {
                        statusDiv = document.createElement('div');
                        statusDiv.id = 'positionUpdateInfo';
                        statusDiv.className = 'position-update-info';
                        const positionsContainer = document.getElementById('uploadedPositions');
                        if (positionsContainer) {
                            positionsContainer.parentNode.insertBefore(statusDiv, positionsContainer);
                        }
                    }
                    
                    statusDiv.innerHTML = `
                        <div class="update-info">
                            <span class="update-label">æ•°æ®æ›´æ–°æ—¶é—´:</span>
                            <span class="update-time">${updateTime}</span>
                        </div>
                    `;
                }
            } else {
                // è®¡ç®—æ€»å¸‚å€¼å’Œæ€»ç›ˆäº
                totalMarketValue = 0;
                totalProfitLoss = 0;
                totalCost = 0;
                
                positions.forEach(position => {
                    totalMarketValue += parseFloat(position.marketValue) || 0;
                    totalProfitLoss += parseFloat(position.profitLoss) || 0;
                    totalCost += parseFloat(position.costPrice) || 0;
                });
                
                profitLossRate = totalCost > 0 ? (totalProfitLoss / totalCost * 100).toFixed(2) : '0.00';
                
                // ç§»é™¤æ›´æ–°æ—¶é—´ä¿¡æ¯
                const updateInfo = document.getElementById('positionUpdateInfo');
                if (updateInfo) {
                    updateInfo.remove();
                }
            }
            
            // æ›´æ–°æ€»å¸‚å€¼å’Œç›ˆäºæ˜¾ç¤º
            totalValueEl.textContent = `Â¥${totalMarketValue.toFixed(2)}`;
            profitLossEl.textContent = `æ€»ç›ˆäº: Â¥${totalProfitLoss.toFixed(2)} (${profitLossRate}%)`;
            
            // ç”ŸæˆæŒä»“åˆ—è¡¨HTML
            let html = '<div class="positions-list">';
            
            positions.forEach(position => {
                const profitLoss = parseFloat(position.profitLoss) || 0;
                const profitLossRate = parseFloat(position.profitLossRate) || 0;
                const isProfit = profitLoss >= 0;
                const profitIcon = isProfit ? 'ğŸ“ˆ' : 'ğŸ“‰';
                
                html += `
                    <div class="position-card">
                        <div class="position-header">
                            <div class="stock-info">
                                <div class="stock-symbol">${position.stockCode}</div>
                                <div class="stock-name">${position.stockName}</div>
                            </div>
                            <div class="profit-indicator ${isProfit ? 'profit' : 'loss'}">
                                ${profitIcon}
                            </div>
                        </div>
                        
                        <div class="position-stats">
                            <div class="stat-row">
                                <div class="stat-item">
                                    <span class="stat-label">æŒä»“æ•°é‡</span>
                                    <span class="stat-value">${position.quantity}è‚¡</span>
                                </div>
                                <div class="stat-item">
                                    <span class="stat-label">æˆæœ¬ä»·</span>
                                    <span class="stat-value">Â¥${parseFloat(position.costPrice).toFixed(2)}</span>
                                </div>
                            </div>
                            
                            <div class="stat-row">
                                <div class="stat-item">
                                    <span class="stat-label">å½“å‰ä»·</span>
                                    <span class="stat-value">Â¥${parseFloat(position.currentPrice).toFixed(2)}</span>
                                </div>
                                <div class="stat-item">
                                    <span class="stat-label">å¸‚å€¼</span>
                                    <span class="stat-value">Â¥${parseFloat(position.marketValue).toFixed(2)}</span>
                                </div>
                            </div>
                        </div>
                        
                        <div class="position-summary">
                            <div class="profit-loss ${isProfit ? 'profit' : 'loss'}">
                                <span class="profit-amount">${isProfit ? '+' : ''}Â¥${profitLoss.toFixed(2)}</span>
                                <span class="profit-rate">${isProfit ? '+' : ''}${profitLossRate.toFixed(2)}%</span>
                            </div>
                        </div>
                    </div>
                `;
            });
            
            html += '</div>';
            container.innerHTML = html;
        }

        // åŠ è½½ç”¨æˆ·æŒä»“æ•°æ®
        async function loadUserPositions() {
            const token = localStorage.getItem('token');
            if (!token) {
                console.log('ç”¨æˆ·æœªç™»å½•ï¼Œè·³è¿‡åŠ è½½æŒä»“æ•°æ®');
                return;
            }
            
            try {
                const response = await fetch('/api/positions', {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });
                
                if (response.ok) {
                    const result = await response.json();
                    if (result.success && result.data.positions.length > 0) {
                        // æ˜¾ç¤ºæŒä»“æ•°æ®
                        displayUploadedPositions(result.data.positions, result.data.summary);
                        
                        // æ˜¾ç¤ºæ›´æ–°æ—¶é—´ä¿¡æ¯
                        if (result.data.summary.lastUpdate) {
                            const updateTime = new Date(result.data.summary.lastUpdate).toLocaleString('zh-CN');
                            
                            // åˆ›å»ºæˆ–æ›´æ–°çŠ¶æ€æ˜¾ç¤ºå…ƒç´ 
                            let statusDiv = document.getElementById('positionUpdateInfo');
                            if (!statusDiv) {
                                statusDiv = document.createElement('div');
                                statusDiv.id = 'positionUpdateInfo';
                                statusDiv.className = 'position-update-info';
                                const positionsContainer = document.getElementById('uploadedPositions');
                                if (positionsContainer) {
                                    positionsContainer.parentNode.insertBefore(statusDiv, positionsContainer);
                                }
                            }
                            
                            statusDiv.innerHTML = `
                                <div class="update-info">
                                    <span class="update-label">æ•°æ®æ›´æ–°æ—¶é—´:</span>
                                    <span class="update-time">${updateTime}</span>
                                </div>
                            `;
                        }
                        
                        console.log('âœ… ç”¨æˆ·æŒä»“æ•°æ®åŠ è½½æˆåŠŸ');
                    } else {
                        console.log('ç”¨æˆ·æš‚æ— æŒä»“æ•°æ®');
                    }
                } else {
                    console.error('è·å–æŒä»“æ•°æ®å¤±è´¥:', response.status);
                }
            } catch (error) {
                console.error('åŠ è½½ç”¨æˆ·æŒä»“æ•°æ®é”™è¯¯:', error);
            }
        }

        // åˆå§‹åŒ–é¡µç­¾åŠŸèƒ½
        function initTabs() {
            // ä¸ºæ‰€æœ‰é¡µç­¾æŒ‰é’®æ·»åŠ ç‚¹å‡»äº‹ä»¶
            document.querySelectorAll('.tab-btn').forEach(btn => {
                btn.onclick = function() {
                    switchTab(this.getAttribute('data-tab'));
                };
            });
        }

        // é¡µç­¾åˆ‡æ¢åŠŸèƒ½
        function switchTab(tabName) {
            // ç§»é™¤æ‰€æœ‰æŒ‰é’®çš„activeç±»
            document.querySelectorAll('.tab-btn').forEach(btn => {
                btn.classList.remove('active');
            });

            // ç§»é™¤æ‰€æœ‰å†…å®¹çš„activeç±»
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.remove('active');
            });

            // æ¿€æ´»é€‰ä¸­çš„æŒ‰é’®
            const btn = document.querySelector(`[data-tab="${tabName}"]`);
            if (btn) btn.classList.add('active');

            // æ˜¾ç¤ºé€‰ä¸­çš„å†…å®¹
            const content = document.getElementById(tabName + '-tab');
            if (content) {
                content.classList.add('active');

                // åŠ è½½é¡µç­¾æ•°æ®
                loadTabData(tabName);
            }
        }
        
        // åŠ è½½é¡µç­¾æ•°æ®
        function loadTabData(tabName) {
            switch (tabName) {
                case 'overview':
                    // æ€»è§ˆé¡µç­¾å·²ç»é»˜è®¤åŠ è½½
                    break;
                case 'market':
                    loadMarketData();
                    break;
                case 'analysis':
                    loadAnalysisData();
                    break;
            }
        }
        
        // åŠ è½½è‚¡å¸‚ä¿¡æ¯æ•°æ®
        function loadMarketData() {
            // åŠ è½½è‡ªé€‰è‚¡åˆ—è¡¨
            loadWatchlist();
            
            // åŠ è½½è‡ªé€‰è‚¡è¡Œæƒ…
            loadWatchlistQuotes();
            
            // åŠ è½½çƒ­ç‚¹æ–°é—»
            loadHotNews();
        }
        
        // åŠ è½½åˆ†ææ•°æ®
        function loadAnalysisData() {
            // æ£€æŸ¥æ˜¯å¦æœ‰æŒä»“æ•°æ®
            const positions = document.querySelectorAll('.position-card');
            if (positions.length === 0) {
                document.getElementById('analysisCharts').innerHTML = 
                    '<div class="loading-text">æš‚æ— æŒä»“æ•°æ®ï¼Œè¯·å…ˆä¸Šä¼ Excelæ–‡ä»¶</div>';
                document.getElementById('analysisStats').innerHTML = 
                    '<div class="loading-text">æš‚æ— åˆ†ææ•°æ®</div>';
                document.getElementById('industryDistribution').innerHTML = 
                    '<div class="loading-text">æš‚æ— è¡Œä¸šåˆ†å¸ƒæ•°æ®</div>';
                document.getElementById('riskAssessment').innerHTML = 
                    '<div class="loading-text">æš‚æ— é£é™©è¯„ä¼°æ•°æ®</div>';
                return;
            }
            
            // æ˜¾ç¤ºåˆ†æå ä½ç¬¦
            document.getElementById('analysisCharts').innerHTML = 
                '<div class="loading-text">å›¾è¡¨åˆ†æåŠŸèƒ½å¼€å‘ä¸­...</div>';
            document.getElementById('analysisStats').innerHTML = 
                '<div class="loading-text">ç»Ÿè®¡æ•°æ®åŠŸèƒ½å¼€å‘ä¸­...</div>';
            document.getElementById('industryDistribution').innerHTML = 
                '<div class="loading-text">è¡Œä¸šåˆ†å¸ƒåˆ†æå¼€å‘ä¸­...</div>';
            document.getElementById('riskAssessment').innerHTML = 
                '<div class="loading-text">é£é™©è¯„ä¼°åŠŸèƒ½å¼€å‘ä¸­...</div>';
        }
        
        // åŠ è½½è‡ªé€‰è‚¡åˆ—è¡¨
        async function loadWatchlist() {
            const container = document.getElementById('watchlistContainer');
            
            if (!container) return;
            
            try {
                // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
                container.innerHTML = '<div class="loading-text">æ­£åœ¨åŠ è½½è‡ªé€‰è‚¡...</div>';
                
                const response = await fetch('/api/watchlist', {
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('token')}`
                    }
                });
                
                if (!response.ok) {
                    throw new Error('è·å–è‡ªé€‰è‚¡åˆ—è¡¨å¤±è´¥');
                }
                
                const result = await response.json();
                
                if (!result.success) {
                    throw new Error(result.error || 'è·å–è‡ªé€‰è‚¡åˆ—è¡¨å¤±è´¥');
                }
                
                const watchlist = result.data || [];
                
                if (watchlist.length === 0) {
                    container.innerHTML = '<div class="loading-text">æš‚æ— è‡ªé€‰è‚¡ï¼Œè¯·æ·»åŠ è‚¡ç¥¨ä»£ç </div>';
                    return;
                }
                
                let html = '';
                watchlist.forEach(stock => {
                    html += `
                        <div class="watchlist-item">
                            <div class="stock-info">
                                <span class="stock-code">${stock.stock_code}</span>
                                <span class="stock-name">${stock.stock_name || 'æœªçŸ¥è‚¡ç¥¨'}</span>
                            </div>
                            <button class="remove-btn" onclick="removeFromWatchlist('${stock.stock_code}')">åˆ é™¤</button>
                        </div>
                    `;
                });
                
                container.innerHTML = html;
                
            } catch (error) {
                console.error('åŠ è½½è‡ªé€‰è‚¡åˆ—è¡¨é”™è¯¯:', error);
                container.innerHTML = '<div class="error-text">åŠ è½½è‡ªé€‰è‚¡å¤±è´¥ï¼Œè¯·åˆ·æ–°é‡è¯•</div>';
            }
        }
        
        // æ·»åŠ è‡ªé€‰è‚¡
        async function addToWatchlist() {
            const input = document.getElementById('stockCodeInput');
            const code = input.value.trim();
            
            if (!code) {
                alert('è¯·è¾“å…¥è‚¡ç¥¨ä»£ç ');
                return;
            }
            
            // ç®€å•çš„è‚¡ç¥¨ä»£ç éªŒè¯
            if (!/^[0-9]{6}$/.test(code)) {
                alert('è¯·è¾“å…¥æ­£ç¡®çš„6ä½è‚¡ç¥¨ä»£ç ');
                return;
            }
            
            try {
                const response = await fetch('/api/watchlist', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${localStorage.getItem('token')}`
                    },
                    body: JSON.stringify({
                        stockCode: code,
                        stockName: '' // åç»­å¯ä»¥é€šè¿‡APIè·å–è‚¡ç¥¨åç§°
                    })
                });
                
                if (!response.ok) {
                    const errorResult = await response.json();
                    throw new Error(errorResult.error || 'æ·»åŠ è‡ªé€‰è‚¡å¤±è´¥');
                }
                
                const result = await response.json();
                
                if (!result.success) {
                    throw new Error(result.error || 'æ·»åŠ è‡ªé€‰è‚¡å¤±è´¥');
                }
                
                // æ¸…ç©ºè¾“å…¥æ¡†
                input.value = '';
                
                // åˆ·æ–°è‡ªé€‰è‚¡åˆ—è¡¨
                await loadWatchlist();
                
                // åˆ·æ–°è‡ªé€‰è‚¡è¡Œæƒ…
                loadWatchlistQuotes();
                
                alert('æ·»åŠ æˆåŠŸï¼');
                
            } catch (error) {
                console.error('æ·»åŠ è‡ªé€‰è‚¡é”™è¯¯:', error);
                alert(error.message || 'æ·»åŠ è‡ªé€‰è‚¡å¤±è´¥');
            }
        }
        
        // ä»è‡ªé€‰è‚¡åˆ é™¤
        async function removeFromWatchlist(code) {
            if (!confirm('ç¡®å®šè¦åˆ é™¤è¿™åªè‡ªé€‰è‚¡å—ï¼Ÿ')) {
                return;
            }
            
            try {
                const response = await fetch(`/api/watchlist/${code}`, {
                    method: 'DELETE',
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('token')}`
                    }
                });
                
                if (!response.ok) {
                    const errorResult = await response.json();
                    throw new Error(errorResult.error || 'åˆ é™¤è‡ªé€‰è‚¡å¤±è´¥');
                }
                
                const result = await response.json();
                
                if (!result.success) {
                    throw new Error(result.error || 'åˆ é™¤è‡ªé€‰è‚¡å¤±è´¥');
                }
                
                // åˆ·æ–°è‡ªé€‰è‚¡åˆ—è¡¨
                await loadWatchlist();
                
                // åˆ·æ–°è‡ªé€‰è‚¡è¡Œæƒ…
                loadWatchlistQuotes();
                
                alert('åˆ é™¤æˆåŠŸï¼');
                
            } catch (error) {
                console.error('åˆ é™¤è‡ªé€‰è‚¡é”™è¯¯:', error);
                alert(error.message || 'åˆ é™¤è‡ªé€‰è‚¡å¤±è´¥');
            }
        }
        
        // åŠ è½½è‡ªé€‰è‚¡è¡Œæƒ…
        async function loadWatchlistQuotes() {
            const container = document.getElementById('watchlistQuotes');
            
            if (!container) return;
            
            try {
                // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
                container.innerHTML = '<div class="loading-text">æ­£åœ¨è·å–è¡Œæƒ…æ•°æ®...</div>';
                
                // è·å–è‡ªé€‰è‚¡åˆ—è¡¨
                const response = await fetch('/api/watchlist', {
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('token')}`
                    }
                });
                
                if (!response.ok) {
                    throw new Error('è·å–è‡ªé€‰è‚¡åˆ—è¡¨å¤±è´¥');
                }
                
                const result = await response.json();
                
                if (!result.success) {
                    throw new Error(result.error || 'è·å–è‡ªé€‰è‚¡åˆ—è¡¨å¤±è´¥');
                }
                
                const watchlist = result.data || [];
                
                if (watchlist.length === 0) {
                    container.innerHTML = '<div class="loading-text">æš‚æ— è‡ªé€‰è‚¡è¡Œæƒ…æ•°æ®</div>';
                    return;
                }
                
                // æ¨¡æ‹Ÿè¡Œæƒ…æ•°æ®ï¼ˆå®é™…åº”ç”¨ä¸­åº”è¯¥è°ƒç”¨APIï¼‰
                setTimeout(() => {
                    let html = '';
                    watchlist.forEach(stock => {
                        // æ¨¡æ‹Ÿä»·æ ¼å’Œæ¶¨è·Œå¹…
                        const basePrice = Math.random() * 100 + 10;
                        const changePercent = (Math.random() - 0.5) * 10;
                        const change = basePrice * changePercent / 100;
                        const currentPrice = basePrice + change;
                        
                        const isPositive = changePercent >= 0;
                        
                        html += `
                            <div class="quote-item">
                                <div class="quote-info">
                                    <span class="quote-symbol">${stock.stock_code}</span>
                                </div>
                                <div class="quote-price">Â¥${currentPrice.toFixed(2)}</div>
                                <div class="quote-change ${isPositive ? 'positive' : 'negative'}">
                                    ${isPositive ? '+' : ''}${changePercent.toFixed(2)}%
                                </div>
                            </div>
                        `;
                    });
                    
                    container.innerHTML = html;
                }, 1000);
                
            } catch (error) {
                console.error('åŠ è½½è‡ªé€‰è‚¡è¡Œæƒ…é”™è¯¯:', error);
                container.innerHTML = '<div class="error-text">è·å–è¡Œæƒ…æ•°æ®å¤±è´¥</div>';
            }
        }
        
        // åŠ è½½çƒ­ç‚¹æ–°é—»
        function loadHotNews() {
            const container = document.getElementById('newsContainer');
            
            if (!container) return;
            
            // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
            container.innerHTML = '<div class="loading-text">æ­£åœ¨åŠ è½½çƒ­ç‚¹æ–°é—»...</div>';
            
            // æ¨¡æ‹Ÿæ–°é—»æ•°æ®ï¼ˆå®é™…åº”ç”¨ä¸­åº”è¯¥è°ƒç”¨APIï¼‰
            setTimeout(() => {
                const news = [
                    {
                        title: 'Aè‚¡å¸‚åœºè¿æ¥å¼€é—¨çº¢ï¼Œä¸‰å¤§æŒ‡æ•°é›†ä½“ä¸Šæ¶¨',
                        source: 'æ–°æµªè´¢ç»',
                        time: '2å°æ—¶å‰'
                    },
                    {
                        title: 'ç§‘æŠ€è‚¡é¢†æ¶¨ï¼Œåˆ›ä¸šæ¿æŒ‡æ¶¨å¹…è¶…è¿‡2%',
                        source: 'è…¾è®¯è´¢ç»',
                        time: '3å°æ—¶å‰'
                    },
                    {
                        title: 'å¤®è¡Œå‘å¸ƒæœ€æ–°è´§å¸æ”¿ç­–æŠ¥å‘Šï¼Œå¼ºè°ƒç¨³å¥ä¸­æ€§',
                        source: 'è´¢ç»ç½‘',
                        time: '5å°æ—¶å‰'
                    },
                    {
                        title: 'å¤–èµ„æŒç»­æµå…¥Aè‚¡å¸‚åœºï¼ŒåŒ—å‘èµ„é‡‘å‡€ä¹°å…¥è¶…50äº¿',
                        source: 'ä¸œæ–¹è´¢å¯Œ',
                        time: '6å°æ—¶å‰'
                    },
                    {
                        title: 'æ–°èƒ½æºæ±½è½¦æ¿å—è¡¨ç°å¼ºåŠ¿ï¼Œå¤šå®¶å…¬å¸æ¶¨åœ',
                        source: 'è¯åˆ¸æ—¶æŠ¥',
                        time: '8å°æ—¶å‰'
                    }
                ];
                
                let html = '';
                news.forEach(item => {
                    html += `
                        <div class="news-item">
                            <div class="news-title">${item.title}</div>
                            <div class="news-meta">
                                <span class="news-source">${item.source}</span>
                                <span class="news-time">${item.time}</span>
                            </div>
                        </div>
                    `;
                });
                
                container.innerHTML = html;
            }, 1500);
        }

        // æ˜¾ç¤ºå…‰å¤§è¯åˆ¸æŒä»“æ•°æ®
        function displayEBSCNPositions(data) {
            const { positions, summary } = data;
            
            // æ›´æ–°æ€»èµ„äº§å’Œæ€»ç›ˆäº
            document.getElementById('ebscnTotalValue').textContent = 
                `Â¥${summary.totalMarketValue.toLocaleString('zh-CN', {minimumFractionDigits: 2})}`;
            
            const profitClass = summary.totalProfitLoss >= 0 ? 'positive' : 'negative';
            document.getElementById('ebscnProfitLoss').innerHTML = 
                `æ€»ç›ˆäº: <span class="${profitClass}">Â¥${summary.totalProfitLoss.toLocaleString('zh-CN', {minimumFractionDigits: 2})} (${summary.totalProfitLossRate}%)</span>`;
            
            // æ˜¾ç¤ºæŒä»“åˆ—è¡¨
            const positionsContainer = document.getElementById('ebscnPositions');
            if (positions.length === 0) {
                positionsContainer.innerHTML = '<div class="loading-text">æš‚æ— æŒä»“æ•°æ®</div>';
                return;
            }

            positionsContainer.innerHTML = positions.map(position => {
                const profitLoss = parseFloat(position.profitLoss) || 0;
                const profitLossRate = parseFloat(position.profitLossRate) || 0;
                const isProfit = profitLoss >= 0;
                const profitIcon = isProfit ? 'ğŸ“ˆ' : 'ğŸ“‰';
                
                return `
                    <div class="position-card">
                        <div class="position-header">
                            <div class="stock-info">
                                <div class="stock-symbol">${position.stockCode}</div>
                                <div class="stock-name">${position.stockName}</div>
                            </div>
                            <div class="profit-indicator ${isProfit ? 'profit' : 'loss'}">
                                ${profitIcon}
                            </div>
                        </div>
                        
                        <div class="position-stats">
                            <div class="stat-row">
                                <div class="stat-item">
                                    <span class="stat-label">æŒä»“æ•°é‡</span>
                                    <span class="stat-value">${position.quantity}è‚¡</span>
                                </div>
                                <div class="stat-item">
                                    <span class="stat-label">æˆæœ¬ä»·</span>
                                    <span class="stat-value">Â¥${parseFloat(position.costPrice).toFixed(2)}</span>
                                </div>
                            </div>
                            
                            <div class="stat-row">
                                <div class="stat-item">
                                    <span class="stat-label">å½“å‰ä»·</span>
                                    <span class="stat-value">Â¥${parseFloat(position.currentPrice).toFixed(2)}</span>
                                </div>
                                <div class="stat-item">
                                    <span class="stat-label">å¸‚å€¼</span>
                                    <span class="stat-value">Â¥${parseFloat(position.marketValue).toFixed(2)}</span>
                                </div>
                            </div>
                        </div>
                        
                        <div class="position-summary">
                            <div class="profit-loss ${isProfit ? 'profit' : 'loss'}">
                                <span class="profit-amount">${isProfit ? '+' : ''}Â¥${profitLoss.toFixed(2)}</span>
                                <span class="profit-rate">${isProfit ? '+' : ''}${profitLossRate.toFixed(2)}%</span>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        // æ›´æ–°å¯¼èˆªæ çŠ¶æ€
        function updateNavbar(user) {
            const loginBtn = document.getElementById('loginBtn');
            const logoutBtn = document.getElementById('logoutBtn');
            const adminBtn = document.getElementById('adminBtn');
            const userName = document.getElementById('userName');
            const userBadge = document.getElementById('userBadge');

            if (user) {
                // å·²ç™»å½•çŠ¶æ€
                userName.textContent = user.username;
                
                // è®¾ç½®ç”¨æˆ·ç­‰çº§æ ‡è¯†
                let badgeText = '';
                let badgeClass = '';
                
                switch(user.role) {
                    case 'super_admin':
                        badgeText = 'è¶…çº§ç®¡ç†å‘˜';
                        badgeClass = 'badge-super-admin';
                        break;
                    case 'admin':
                        badgeText = 'ç®¡ç†å‘˜';
                        badgeClass = 'badge-admin';
                        break;
                    default:
                        badgeText = 'ç”¨æˆ·';
                        badgeClass = 'badge-user';
                }
                
                userBadge.textContent = badgeText;
                userBadge.className = `user-badge ${badgeClass}`;
                
                loginBtn.style.display = 'none';
                logoutBtn.style.display = 'inline-block';
                
                // å¦‚æœæ˜¯ç®¡ç†å‘˜ï¼Œæ˜¾ç¤ºç®¡ç†æŒ‰é’®
                if (user.role === 'admin' || user.role === 'super_admin') {
                    adminBtn.style.display = 'inline-block';
                } else {
                    adminBtn.style.display = 'none';
                }
            } else {
                // æœªç™»å½•çŠ¶æ€
                userName.textContent = 'æ¸¸å®¢';
                userBadge.textContent = 'æ¸¸å®¢';
                userBadge.className = 'user-badge badge-user';
                loginBtn.style.display = 'inline-block';
                logoutBtn.style.display = 'none';
                adminBtn.style.display = 'none';
                
                // æ¸…é™¤æœ¬åœ°å­˜å‚¨
                localStorage.removeItem('token');
                localStorage.removeItem('user');
            }
        }

        // è·³è½¬åˆ°ç™»å½•é¡µé¢
        function goToLogin() {
            window.location.href = '/login.html';
        }

        // è·³è½¬åˆ°ç®¡ç†é¡µé¢
        function goToAdmin() {
            window.location.href = '/admin.html';
        }

        // é€€å‡ºç™»å½•
        function logout() {
            localStorage.removeItem('token');
            localStorage.removeItem('user');
            updateNavbar(null);
            
            // æ˜¾ç¤ºé€€å‡ºæˆåŠŸæ¶ˆæ¯
            showNotification('å·²æˆåŠŸé€€å‡ºç™»å½•', 'success');
        }

        // æ˜¾ç¤ºé€šçŸ¥
        function showNotification(message, type = 'info') {
            // åˆ›å»ºé€šçŸ¥å…ƒç´ 
            const notification = document.createElement('div');
            notification.className = `notification ${type}`;
            notification.textContent = message;
            
            // æ·»åŠ åˆ°é¡µé¢
            document.body.appendChild(notification);
            
            // 3ç§’åè‡ªåŠ¨ç§»é™¤
            setTimeout(() => {
                notification.remove();
            }, 3000);
        }

        // æ›´æ–°å½“å‰æ—¶é—´
        function updateTime() {
            const now = new Date();
            const timeString = now.toLocaleTimeString('zh-CN');
            const dateString = now.toLocaleDateString('zh-CN');
            
            document.getElementById('currentTime').textContent = timeString;
            
            // æ¯5åˆ†é’Ÿæ›´æ–°ä¸€æ¬¡æœ€åæ›´æ–°æ—¶é—´
            if (now.getMinutes() % 5 === 0 && now.getSeconds() === 0) {
                document.getElementById('lastUpdate').textContent = `${dateString} ${timeString}`;
            }
        }

        // æ¨¡æ‹Ÿè‚¡ç¥¨æ•°æ®æ›´æ–°
        function updateStockData() {
            const stocks = ['AAPL', 'GOOGL', 'MSFT', 'TSLA', 'AMZN'];
            
            stocks.forEach(stock => {
                const priceElement = document.querySelector(`[data-stock="${stock}"] .stock-price`);
                const changeElement = document.querySelector(`[data-stock="${stock}"] .stock-change`);
                
                if (priceElement && changeElement) {
                    const currentPrice = parseFloat(priceElement.textContent.replace('$', '')) || 100;
                    const change = (Math.random() - 0.5) * 10;
                    const newPrice = Math.max(1, currentPrice + change);
                    const changePercent = ((change / currentPrice) * 100).toFixed(2);
                    
                    priceElement.textContent = `$${newPrice.toFixed(2)}`;
                    changeElement.textContent = `${changePercent}%`;
                    changeElement.className = `stock-change ${change >= 0 ? 'positive' : 'negative'}`;
                }
            });
        }

        // æ·»åŠ é€šçŸ¥æ ·å¼
        const style = document.createElement('style');
        style.textContent = `
            .notification {
                position: fixed;
                top: 20px;
                right: 20px;
                padding: 15px 20px;
                border-radius: 8px;
                color: white;
                font-weight: 600;
                z-index: 1000;
                animation: slideIn 0.3s ease;
            }
            
            .notification.success {
                background: linear-gradient(135deg, #27ae60, #2ecc71);
            }
            
            .notification.info {
                background: linear-gradient(135deg, #3498db, #2980b9);
            }
            
            .notification.error {
                background: linear-gradient(135deg, #e74c3c, #c0392b);
            }
            
            @keyframes slideIn {
                from {
                    transform: translateX(100%);
                    opacity: 0;
                }
                to {
                    transform: translateX(0);
                    opacity: 1;
                }
            }
            
            .status-indicator {
                display: inline-block;
                width: 8px;
                height: 8px;
                border-radius: 50%;
                margin-left: 8px;
            }
            
            .status-indicator.online {
                background: #27ae60;
            }
            
            .status-indicator.offline {
                background: #95a5a6;
            }
            
            .user-info {
                display: flex;
                align-items: center;
                margin-right: 15px;
                font-weight: 600;
            }
        `;
        document.head.appendChild(style);
    </script>
