# 股票分时数据缓存和多API源优化方案

## 📋 概述
本次优化针对股票分时数据获取频率过高的问题，实现了智能缓存机制和多个API数据源的自动切换，有效降低了API请求频率并提升了系统的稳定性和可用性。

---

## ✨ 已实现功能

### 1. **分时数据缓存机制** (stockCache.js)

#### 缓存策略
- **交易时间内**：缓存有效期 **1分钟**（分时数据更新更频繁）
- **非交易时间**：缓存到下一个交易时段开始
- **自动判断**：系统自动识别交易日（周一至周五）和交易时间（9:30-11:30, 13:00-15:00）

#### 新增方法
```javascript
// 获取分时数据缓存
stockCache.getIntraday(stockCode, period, limit)

// 设置分时数据缓存
stockCache.setIntraday(stockCode, period, limit, data)
```

#### 缓存键值格式
`{stockCode}_{period}_{limit}`
例如: `600036_5_100` (600036股票,5分钟周期,100条数据)

### 2. **多API数据源支持** (server.js)

#### 数据源优先级
系统会按以下顺序尝试获取分时数据,一旦某个源失败会自动切换到下一个:

1. **腾讯财经API (首选)** - `https://web.ifzq.gtimg.cn/`
   - 优点: 稳定性较好,数据完整
   - 支持周期: 1分钟(m1), 5分钟(m5), 15分钟(m15), 30分钟(m30), 60分钟(m60)
   - 格式: JSONP格式需要解析

2. **新浪财经API (备用)** - `http://money.finance.sina.com.cn/`
   - 优点: 传统稳定,数据格式简单
   - 支持周期: 1, 5, 15, 30, 60, 240分钟
   - 注意: 可能存在频率限制(456错误)

3. **网易财经API (备用)** - 暂未实现
   - 预留接口,未来可扩展
   - 目前返回"不支持分钟级数据"错误

#### API自动切换逻辑
```
请求分时数据
    ↓
检查缓存
    ↓ (未命中)
尝试腾讯API
    ↓ (失败)
尝试新浪API
    ↓ (失败)
尝试网易API
    ↓ (失败)
返回所有源均失败错误
```

### 3. **API接口改进**

#### 请求格式
```
GET /api/stock/intraday/:stockCode?period=5&limit=100
```

#### 响应格式
```json
{
  "success": true,
  "data": {
    "stockCode": "600036",
    "stockName": "招商银行",
    "period": "5",
    "count": 48,
    "intraday": [
      {
        "time": "2025-10-10 09:30:00",
        "open": 45.20,
        "high": 45.50,
        "low": 45.10,
        "close": 45.40,
        "volume": 125000
      }
    ]
  },
  "cached": false,     // 是否来自缓存
  "source": "tencent"  // 数据来源: cache/tencent/sina/netease
}
```

---

## 🎯 优化效果

### 缓存命中率
- **首次请求**: 从API获取 → 缓存
- **后续请求**: 在缓存有效期内直接使用缓存数据
- **预估缓存命中率**:
  - 交易时间: ~70-80% (1分钟缓存)
  - 非交易时间: ~95%+ (长时间缓存)

### API请求频率降低
- **优化前**: 每次刷新页面/图表都会请求API
- **优化后**:
  - 交易时间: 每分钟最多请求1次
  - 非交易时间: 几乎不请求

### 系统稳定性提升
- **多源容错**: 一个API失败自动切换到备用源
- **错误处理**: 详细的错误日志和来源标记
- **降低封禁风险**: 通过缓存大幅降低API请求频率

---

## 📊 缓存统计

可通过以下API查看缓存状态:

```
GET /api/cache/stats
```

响应示例:
```json
{
  "success": true,
  "data": {
    "quoteCount": 15,      // 实时行情缓存数
    "historyCount": 8,     // 历史数据缓存数
    "intradayCount": 12,   // 分时数据缓存数
    "isTradeTime": false,  // 当前是否交易时间
    "message": "当前为非交易时间，缓存到下一个交易时段"
  }
}
```

---

## ⚠️ 注意事项

### 1. API限制问题
- **456错误**: 新浪API频繁访问可能被限制
- **建议**:
  - 优先使用腾讯API (已设为首选)
  - 确保缓存机制正常工作
  - 避免短时间内大量请求

### 2. 交易时间判断
- 系统自动判断交易日和交易时间
- 未考虑节假日因素
- **建议**: 未来可接入交易日历API

### 3. 缓存过期清理
- 系统每5分钟自动清理过期缓存
- 可手动清空缓存: `POST /api/cache/clear` (需管理员权限)

### 4. 数据一致性
- 缓存期间数据不会更新
- 交易时间内最多延迟1分钟
- 非交易时间数据为静态数据

---

## 🔧 配置建议

### 调整缓存时间
在 `stockCache.js` 中修改:

```javascript
if (this.isTradeTime()) {
    // 交易时间：缓存1分钟 (可调整为30秒或2分钟)
    expiresAt = now + 60 * 1000;
} else {
    // 非交易时间：缓存到下一个交易时段
    expiresAt = this.getNextTradeTimeStart();
}
```

### 更换API优先级
在 `server.js` 中调整尝试顺序:

```javascript
// 方案1: 腾讯 (首选) → 新浪 (备用) → 网易 (备用)
try {
    result = await fetchIntradayFromTencent(...);
} catch {
    try {
        result = await fetchIntradayFromSina(...);
    } catch {
        result = await fetchIntradayFromNetease(...);
    }
}
```

---

## 📈 未来优化方向

### 1. 接入更多数据源
- 东方财富API
- 通达信API
- 雪球API

### 2. 智能API切换
- 记录每个API的成功率和响应时间
- 动态调整API优先级
- 失败源自动降级

### 3. 交易日历集成
- 接入官方交易日历
- 准确判断节假日
- 精确的缓存过期时间

### 4. 缓存持久化
- 使用Redis存储缓存
- 跨服务器实例共享缓存
- 更长的缓存有效期

### 5. 分级缓存策略
- 热门股票: 更短的缓存时间
- 冷门股票: 更长的缓存时间
- 根据请求频率动态调整

---

## 📞 技术支持

如遇到问题,请检查:

1. 服务器日志中的API请求状态
2. 缓存统计信息 (`/api/cache/stats`)
3. 网络连接和API可用性

日志关键字:
- `📊 获取 xxx 的 x 分钟分时数据` - 开始请求
- `📦 使用缓存的分时数据` - 缓存命中
- `💾 缓存分时数据` - 数据已缓存
- `📡 尝试使用xxx API` - API切换
- `✅ xxx API获取成功` - 数据获取成功
- `⚠️ xxx API失败` - API失败,切换到下一个

---

## 📝 更新日志

### 2025-10-10
- ✅ 实现分时数据缓存机制
- ✅ 集成腾讯财经API作为首选数据源
- ✅ 实现多API源自动切换
- ✅ 优化缓存过期策略(交易时间/非交易时间)
- ✅ 添加数据来源标记和缓存状态
- ✅ 完善错误处理和日志记录

---

**实现状态**: ✅ **已完成并部署**

感谢使用本系统!
