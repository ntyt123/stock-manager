
FROM node:bullseye-slim
USER root


# 使用官方Debian镜像源（移除backports源，避免Release文件缺失问题）
RUN echo "deb http://deb.debian.org/debian/ bullseye main non-free contrib" > /etc/apt/sources.list && \
echo "deb-src http://deb.debian.org/debian/ bullseye main non-free contrib" >> /etc/apt/sources.list && \
echo "deb http://deb.debian.org/debian-security/ bullseye-security main" >> /etc/apt/sources.list && \
echo "deb-src http://deb.debian.org/debian-security/ bullseye-security main" >> /etc/apt/sources.list && \
echo "deb http://deb.debian.org/debian/ bullseye-updates main non-free contrib" >> /etc/apt/sources.list && \
echo "deb-src http://deb.debian.org/debian/ bullseye-updates main non-free contrib" >> /etc/apt/sources.list && \
# 调整pip源为官方源，解决mysqlclient找不到的问题
echo  "[global]\n\
index-url=https://pypi.org/simple\n\
trusted-host=pypi.org\n\
files.pythonhosted.org" > /etc/pip.conf && \
ln -sf /usr/share/zoneinfo/Asia/Shanghai /etc/localtime && \
    echo "Asia/Shanghai" > /etc/timezone

#增加语言utf-8
ENV LANG=zh_CN.UTF-8
ENV LC_CTYPE=zh_CN.UTF-8
ENV LC_ALL=C

# 安装mysqlclient依赖库及Python3.7（满足akshare需求）
RUN apt-get update && apt-get install -y \
    python3.7 \
    python3-pip \
    python3.7-dev \
    default-libmysqlclient-dev \
    build-essential \
    && apt-get clean \
    && ln -s /usr/bin/python3.7 /usr/bin/python3 \
    && ln -s /usr/bin/python3.7 /usr/bin/python

# 增加 TensorFlow 的支持，使用最新的2.0 编写代码。目前还是使用 1.x 吧，还没有学明白。
# RUN pip3 install tensorflow==2.0.0-rc1 keras
# RUN pip3 install tensorflow keras sklearn

# 设置 vim 的语言配置
RUN mkdir -p /etc/vim/ && \
    echo "set fileencodings=utf-8,ucs-bom,gb18030,gbk,gb2312,cp936" >> /etc/vim/vimrc && \
    echo "set termencoding=utf-8" >> /etc/vim/vimrc && \
    echo "set encoding=utf-8" >> /etc/vim/vimrc

# 安装所需Python库（包含mysqlclient及项目依赖）
RUN pip3 install --upgrade pip && \
    pip3 install \
    mysqlclient \
    sqlalchemy \
    requests \
    numpy \
    tushare \
    tornado \
    torndb \
    bokeh \
    stockstats \
    ta-lib \
    jupyter \
    sklearn \
    akshare>=0.9.65 && \
    apt-get update && apt-get install -y make g++ && apt-get clean