# 使用 node:bullseye-slim 作为基础镜像，减少镜像大小
# 选择兼容的Node.js版本（避免最新版编译问题）
USER root
FROM node:16.20.2-bullseye-slim

# 配置阿里云Debian源（移除backports，避免Release文件错误）
RUN echo "deb http://mirrors.aliyun.com/debian/ bullseye main non-free contrib" > /etc/apt/sources.list && \
    echo "deb-src http://mirrors.aliyun.com/debian/ bullseye main non-free contrib" >> /etc/apt/sources.list && \
    echo "deb http://mirrors.aliyun.com/debian-security/ bullseye-security main" >> /etc/apt/sources.list && \
    echo "deb-src http://mirrors.aliyun.com/debian-security/ bullseye-security main" >> /etc/apt/sources.list && \
    echo "deb http://mirrors.aliyun.com/debian/ bullseye-updates main non-free contrib" >> /etc/apt/sources.list && \
    echo "deb-src http://mirrors.aliyun.com/debian/ bullseye-updates main non-free contrib" >> /etc/apt/sources.list && \
    # 配置npm国内镜像（加速Node.js依赖安装）
    npm config set registry https://registry.npmmirror.com && \
    # 设置时区为上海
    ln -sf /usr/share/zoneinfo/Asia/Shanghai /etc/localtime && \
    echo "Asia/Shanghai" > /etc/timezone

# 配置语言环境为UTF-8
ENV LANG=zh_CN.UTF-8
ENV LC_CTYPE=zh_CN.UTF-8
ENV LC_ALL=C

# 配置vim编码（方便容器内编辑）
RUN apt-get update && apt-get install -y vim && \
    mkdir -p /etc/vim/ && \
    echo "set fileencodings=utf-8,ucs-bom,gb18030,gbk,gb2312,cp936" >> /etc/vim/vimrc && \
    echo "set termencoding=utf-8" >> /etc/vim/vimrc && \
    echo "set encoding=utf-8" >> /etc/vim/vimrc && \
    apt-get clean && rm -rf /var/lib/apt/lists/*

# 安装必要的系统依赖（含Python3环境，用于可能的脚本执行）
RUN apt-get update && apt-get install -y \
    python3 \
    python3-pip \
    make \
    g++ \
    && apt-get clean && rm -rf /var/lib/apt/lists/*

# 配置pip国内镜像（若需要使用Python库）
RUN echo "[global]\n\
trusted-host=mirrors.aliyun.com\n\
index-url=http://mirrors.aliyun.com/pypi/simple" > /etc/pip.conf

# 清理缓存，进一步减小镜像体积
RUN rm -rf /var/cache/apt/* && \
    rm -rf /root/.npm/*